<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LIN MART EXECUTIVE HOSTEL — Booking & Admin</title>
  <meta name="description" content="LIN MART EXECUTIVE HOSTEL booking system with Firebase sync + EmailJS emails (no PHP)." />

  <!-- EmailJS (no backend) -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --panel:rgba(255,255,255,.06);
      --panel2:rgba(255,255,255,.04);
      --text:#eaf1ff;
      --muted:#a9b7d6;
      --line:rgba(255,255,255,.10);
      --shadow:0 12px 34px rgba(0,0,0,.45);
      --radius:18px;
      --radius2:14px;
      --accent:#7c5cff;
      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(1200px 650px at 15% 10%, rgba(124,92,255,.20), transparent 45%),
        radial-gradient(900px 560px at 90% 0%, rgba(34,197,94,.16), transparent 40%),
        var(--bg);
      line-height:1.45;
    }
    .wrap{max-width:1180px; margin:0 auto; padding:26px 16px 56px;}
    header{display:flex; align-items:flex-start; justify-content:space-between; gap:14px; padding:8px 0 18px;}
    .brand h1{margin:0; font-size:20px; letter-spacing:.3px}
    .brand p{margin:8px 0 0; color:var(--muted); font-size:13px; max-width:860px}
    .tabs{
      display:flex; gap:8px; padding:6px;
      border:1px solid var(--line);
      background:var(--panel2);
      border-radius:999px;
      box-shadow:var(--shadow);
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
    }
    .tabbtn{
      border:none; cursor:pointer;
      padding:10px 12px; border-radius:999px;
      background:transparent; color:var(--muted);
      font-weight:900; font-size:13px; letter-spacing:.2px;
    }
    .tabbtn.active{background:linear-gradient(90deg, var(--accent), #4cc3ff); color:#071018;}

    .grid{display:grid; grid-template-columns: 1.18fr .82fr; gap:18px; align-items:start;}
    @media (max-width: 980px){ .grid{ grid-template-columns:1fr; } }

    .card{
      border:1px solid var(--line);
      background:linear-gradient(180deg, var(--panel), rgba(255,255,255,.03));
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .head{ padding:18px 18px 0; }
    .head h2{ margin:0; font-size:16px; letter-spacing:.25px; }
    .head p{ margin:8px 0 0; color:var(--muted); font-size:13px; }

    .rooms{padding:18px; display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:12px;}
    @media (max-width: 740px){ .rooms{ grid-template-columns:1fr; } }
    .room{
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      border-radius:var(--radius2);
      padding:14px;
      display:flex; flex-direction:column; gap:10px;
      min-height:170px;
    }
    .tag{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--muted);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      width:max-content;
    }
    .price{ font-size:22px; font-weight:900; letter-spacing:.2px; }
    .sub{ color:var(--muted); font-size:12px; margin-top:-6px; }
    .avail{
      margin-top:auto;
      display:flex; justify-content:space-between; gap:10px;
      border-top:1px dashed rgba(255,255,255,.14);
      padding-top:10px;
      color:var(--muted);
      font-size:12px;
    }
    .avail strong{ color:var(--text); }

    .toast{
      display:none;
      margin:14px 18px 0;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(34,197,94,.12);
      color:#d7ffe6;
      font-size:13px;
      white-space:pre-wrap;
    }
    .toast.error{ background:rgba(239,68,68,.12); color:#ffe0e0; }

    form{ padding:18px; display:grid; gap:14px; }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width: 640px){ .row{ grid-template-columns:1fr; } }
    label{ display:block; font-size:12px; color:var(--muted); margin:0 0 6px; }
    input, select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.24);
      color:var(--text);
      outline:none;
      transition:border .15s ease, box-shadow .15s ease;
    }
    textarea{ min-height:92px; resize:vertical; }
    input:focus, select:focus, textarea:focus{
      border-color:rgba(124,92,255,.7);
      box-shadow:0 0 0 4px rgba(124,92,255,.18);
    }

    .summary{padding:18px; border-top:1px solid var(--line); display:grid; gap:10px;}
    .kv{
      display:flex; justify-content:space-between; gap:12px;
      padding:10px 12px;
      border:1px dashed rgba(255,255,255,.14);
      border-radius:14px;
      background:rgba(0,0,0,.12);
      color:var(--muted);
      font-size:13px;
    }
    .kv strong{ color:var(--text); font-weight:900; }

    .actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:4px; }
    button{
      cursor:pointer; border:none;
      padding:12px 14px;
      border-radius:14px;
      font-weight:900;
      letter-spacing:.2px;
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
    }
    .btn-primary{ background:linear-gradient(90deg, var(--accent), #4cc3ff); color:#071018; }
    .btn-ghost{ background:rgba(255,255,255,.06); color:var(--text); border:1px solid var(--line); }
    .btn-danger{ background:rgba(239,68,68,.16); color:#ffe0e0; border:1px solid rgba(239,68,68,.30); }
    .btn-warn{ background:rgba(245,158,11,.14); color:#fff1d6; border:1px solid rgba(245,158,11,.30); }
    button:disabled{ opacity:.55; cursor:not-allowed; }
    .note{ color:var(--muted); font-size:12px; padding:0 18px 18px; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .adminWrap{ padding:18px; }
    .adminToolbar{
      display:flex; flex-wrap:wrap; gap:10px; align-items:center;
      padding:14px; border-bottom:1px solid var(--line);
    }
    .adminToolbar input, .adminToolbar select{
      border-radius:12px; border:1px solid var(--line);
      background:rgba(0,0,0,.24); color:var(--text);
      padding:10px 12px; outline:none;
    }
    .adminToolbar input{ flex:1; min-width:240px; }

    .kpis{padding:14px; display:flex; gap:10px; flex-wrap:wrap;}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      border-radius:999px;
      padding:6px 10px;
      color:var(--muted);
      font-size:12px;
    }
    .pill.good{ border-color:rgba(34,197,94,.30); background:rgba(34,197,94,.10); color:#d7ffe6; }
    .pill.warn{ border-color:rgba(245,158,11,.35); background:rgba(245,158,11,.10); color:#fff1d6; }
    .pill.bad{ border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.10); color:#ffe0e0; }
    .pill.info{ border-color:rgba(124,92,255,.35); background:rgba(124,92,255,.10); color:#eae5ff; }

    table{ width:100%; border-collapse:collapse; }
    th, td{ padding:12px 12px; border-bottom:1px solid var(--line); vertical-align:top; font-size:13px; }
    th{ text-align:left; color:var(--muted); font-weight:900; font-size:12px; letter-spacing:.25px; }
    tr:hover td{ background:rgba(255,255,255,.03); }

    .statusPill{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }
    .statusPill.good{ border-color:rgba(34,197,94,.30); background:rgba(34,197,94,.10); color:#d7ffe6; }
    .statusPill.warn{ border-color:rgba(245,158,11,.35); background:rgba(245,158,11,.10); color:#fff1d6; }
    .statusPill.bad{ border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.10); color:#ffe0e0; }
    .statusPill.info{ border-color:rgba(124,92,255,.35); background:rgba(124,92,255,.10); color:#eae5ff; }

    .hide{ display:none !important; }
    footer{ margin-top:18px; color:var(--muted); font-size:12px; text-align:center; opacity:.9; }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <h1>LIN MART EXECUTIVE HOSTEL</h1>
        <p>
          Book a room (any device). Admin sees bookings live (all devices). Emails sent via EmailJS.
          <br><span class="mono">No PHP. Uses Firebase Firestore (cloud database).</span>
        </p>
      </div>

      <div class="tabs" role="tablist" aria-label="Switch view">
        <button class="tabbtn active" id="tabBooking" type="button" role="tab" aria-selected="true">Booking</button>
        <button class="tabbtn" id="tabAdmin" type="button" role="tab" aria-selected="false">Admin</button>
      </div>
    </header>

    <!-- BOOKING -->
    <section id="viewBooking">
      <div class="grid">
        <section class="card">
          <div class="head">
            <h2>Room Types, Pricing & Availability</h2>
            <p>Sharing is gender-based (girls with girls, boys with boys). Admin can also pair roommates.</p>
          </div>

          <div class="rooms">
            <div class="room">
              <div class="tag">1 in a room</div>
              <div class="price">GHS 14,000</div>
              <div class="sub">Single Building • 2 floors • 6 rooms each floor (12 rooms total)</div>
              <div class="avail"><span>Available spaces</span><strong id="av1">—</strong></div>
            </div>
            <div class="room">
              <div class="tag">2 in a room</div>
              <div class="price">GHS 7,000</div>
              <div class="sub">Main Building • 3 floors • 8 rooms each floor (24 rooms total)</div>
              <div class="avail"><span>Available spaces</span><strong id="av2">—</strong></div>
            </div>
            <div class="room">
              <div class="tag">3 in a room</div>
              <div class="price">GHS 5,500</div>
              <div class="sub">Main Building • Floors 1–2 • Rooms 09–11 (6 rooms total)</div>
              <div class="avail"><span>Available spaces</span><strong id="av3">—</strong></div>
            </div>
          </div>

          <div class="note">
            <strong>Bank payment details:</strong><br/>
            Account Name: <span class="mono">LIN MART EXECUTIVE HOSTEL</span><br/>
            Account Number: <span class="mono">1621180004574</span><br/>
            Bank: <span class="mono">GCB</span>, Branch: <span class="mono">HAATSO BRANCH</span><br/>
            <br/>
            <strong>Instruction:</strong> After allocation, pay into the account and keep your receipt/transaction reference.
          </div>
        </section>

        <aside class="card">
          <div class="head">
            <h2>Book a Room</h2>
            <p>Email is required so we can send confirmation and allocation details.</p>
          </div>

          <div id="toastBooking" class="toast" role="status" aria-live="polite"></div>

          <form id="bookingForm" autocomplete="on" novalidate>
            <div class="row">
              <div>
                <label for="fullName">Full name</label>
                <input id="fullName" type="text" placeholder="e.g., Edric Atebi" required minlength="2" />
              </div>
              <div>
                <label for="phone">Phone number</label>
                <input id="phone" type="tel" placeholder="e.g., 024 000 0000" required />
              </div>
            </div>

            <div class="row">
              <div>
                <label for="email">Email (required)</label>
                <input id="email" type="email" placeholder="e.g., you@example.com" required />
              </div>
              <div>
                <label for="gender">Gender</label>
                <select id="gender" required>
                  <option value="" selected disabled>Select gender</option>
                  <option value="female">Female</option>
                  <option value="male">Male</option>
                </select>
              </div>
            </div>

            <div class="row">
              <div>
                <label for="school">School / Institution</label>
                <input id="school" type="text" placeholder="e.g., University of ..." required />
              </div>
              <div>
                <label for="roomType">Room type</label>
                <select id="roomType" required>
                  <option value="" selected disabled>Select a room type</option>
                  <option value="1">1 in a room — GHS 14,000</option>
                  <option value="2">2 in a room — GHS 7,000</option>
                  <option value="3">3 in a room — GHS 5,500</option>
                </select>
              </div>
            </div>

            <div class="row">
              <div>
                <label for="moveIn">Preferred move-in date</label>
                <input id="moveIn" type="date" required />
              </div>
              <div>
                <label for="duration">Duration</label>
                <select id="duration" required>
                  <option value="1" selected>1 semester / term</option>
                  <option value="2">2 semesters / full year</option>
                </select>
              </div>
            </div>

            <div>
              <label for="notes">Notes (optional)</label>
              <textarea id="notes" placeholder="Any special request?"></textarea>
            </div>

            <div class="actions">
              <button id="submitBtn" class="btn-primary" type="button">Submit Booking</button>
              <button id="resetBtn" class="btn-ghost" type="button">Reset</button>
            </div>
          </form>

          <div class="summary">
            <div class="kv"><span>Selected room</span><strong id="sumRoom">—</strong></div>
            <div class="kv"><span>Price</span><strong id="sumRoomPrice">—</strong></div>
            <div class="kv"><span>Gender</span><strong id="sumGender">—</strong></div>
            <div class="kv"><span>Availability (gender-based)</span><strong id="sumAvail">—</strong></div>
          </div>

          <div class="note">
            Email templates:
            <span class="mono">template_lkwqlmo</span> (booking received) •
            <span class="mono">template_pp7xixk</span> (booking allocated)
          </div>
        </aside>
      </div>
    </section>

    <!-- ADMIN -->
    <section id="viewAdmin" class="hide">
      <div class="card">
        <div class="head">
          <h2>Admin Dashboard</h2>
          <p>Live bookings from all devices. Allocate rooms, pair roommates, mark paid, release, reject, resend email, WhatsApp.</p>
        </div>

        <div id="toastAdmin" class="toast" role="status" aria-live="polite"></div>

        <div id="adminLogin" class="adminWrap">
          <div class="row">
            <div>
              <label for="adminUser">Username</label>
              <input id="adminUser" type="text" value="admin" autocomplete="username" />
            </div>
            <div>
              <label for="adminPass">Password</label>
              <input id="adminPass" type="password" placeholder="Enter password" autocomplete="current-password" />
            </div>
          </div>
          <div class="actions" style="margin-top:12px;">
            <button id="loginBtn" class="btn-primary" type="button">Sign in</button>
          </div>
          <div class="note" style="padding:12px 0 0;">
            Demo password is <span class="mono">admin123</span>. Change it before publishing.
          </div>
        </div>

        <div id="adminPanel" class="hide">
          <div class="adminToolbar">
            <input id="search" type="search" placeholder="Search name, phone, email, school..." />
            <select id="filterRoom">
              <option value="">All room types</option>
              <option value="1">1 in a room</option>
              <option value="2">2 in a room</option>
              <option value="3">3 in a room</option>
            </select>
            <select id="filterGender">
              <option value="">All genders</option>
              <option value="female">Female</option>
              <option value="male">Male</option>
            </select>
            <select id="filterStatus">
              <option value="">All status</option>
              <option value="allocated">Allocated</option>
              <option value="waitlist">Waitlist</option>
              <option value="paid">Paid (confirmed)</option>
              <option value="rejected">Rejected</option>
            </select>

            <button class="btn-danger" id="clearBtn" type="button">Clear all bookings</button>
            <button class="btn-primary" id="logoutBtn" type="button">Logout</button>
          </div>

          <div class="kpis">
            <span class="pill">Total: <strong id="kTotal">0</strong></span>
            <span class="pill info">Allocated: <strong id="kAllocated">0</strong></span>
            <span class="pill warn">Waitlist: <strong id="kWaitlist">0</strong></span>
            <span class="pill good">Paid: <strong id="kPaid">0</strong></span>
            <span class="pill bad">Rejected: <strong id="kRejected">0</strong></span>
          </div>

          <div class="note" style="padding-top:0;">
            Available spaces: 1-in: <strong id="a1Admin">—</strong> • 2-in: <strong id="a2Admin">—</strong> • 3-in: <strong id="a3Admin">—</strong>
          </div>

          <div style="overflow:auto;">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Student</th>
                  <th>Gender</th>
                  <th>Room Type</th>
                  <th>Allocation</th>
                  <th>Roommates</th>
                  <th>Move-in</th>
                  <th>Status</th>
                  <th style="min-width:650px;">Actions</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>

          <div class="note">
            If admin opens on another device, it still shows the same bookings (cloud).
          </div>
        </div>
      </div>
    </section>

    <footer>© <span id="year"></span> LIN MART EXECUTIVE HOSTEL</footer>
  </div>

  <script type="module">
    // ================== FIREBASE (CDN MODULES) ==================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      getDoc,
      setDoc,
      doc,
      updateDoc,
      deleteDoc,
      getDocs,
      query,
      orderBy,
      onSnapshot,
      serverTimestamp,
      runTransaction
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD_41JZpf3N-31ygWwy-QB-GATaQ6aKY2g",
      authDomain: "lin-mart-hostel.firebaseapp.com",
      projectId: "lin-mart-hostel",
      storageBucket: "lin-mart-hostel.firebasestorage.app",
      messagingSenderId: "350829752888",
      appId: "1:350829752888:web:174ac2acb9204986c22ccd",
      measurementId: "G-3CGFQGP0KH"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ================== EMAILJS (YOUR REAL IDs) ==================
    const EMAIL = {
      publicKey: "u7PnlhwIw05D-Rqh9",
      serviceId: "service_agply6t",
      tplBooking: "template_lkwqlmo",
      tplAllocated: "template_pp7xixk"
    };

    if (window.emailjs && EMAIL.publicKey) {
      window.emailjs.init(EMAIL.publicKey);
    }

    async function sendEmail(templateId, params){
      try{
        if (!window.emailjs) return;
        await window.emailjs.send(EMAIL.serviceId, templateId, params);
      } catch (e){
        console.error("Email failed:", e);
      }
    }

    // ================== CONFIG ==================
    const HOSTEL_NAME = "LIN MART EXECUTIVE HOSTEL";

    const PRICES = { "1": 14000, "2": 7000, "3": 5500 };

    const BANK = {
      accountName: "LIN MART EXECUTIVE HOSTEL",
      accountNumber: "1621180004574",
      bank: "GCB",
      branch: "HAATSO BRANCH"
    };

    const ADMIN_USER = "admin";
    const ADMIN_PASS = "admin123"; // change before publish

    const MAIN_BUILDING = "Main Building";
    const SINGLE_BUILDING = "Single Building";

    // Rooms: 1-in separate building (12 rooms), 2-in (24 rooms), 3-in (6 rooms)
    const ROOM_SETUP = {
      "1": {
        building: SINGLE_BUILDING,
        floors: [1, 2],
        roomsPerFloor: { 1:["01","02","03","04","05","06"], 2:["01","02","03","04","05","06"] },
        capacity: 1
      },
      "2": {
        building: MAIN_BUILDING,
        floors: [1, 2, 3],
        roomsPerFloor: {
          1:["01","02","03","04","05","06","07","08"],
          2:["01","02","03","04","05","06","07","08"],
          3:["01","02","03","04","05","06","07","08"]
        },
        capacity: 2
      },
      "3": {
        building: MAIN_BUILDING,
        floors: [1, 2],
        roomsPerFloor: { 1:["09","10","11"], 2:["09","10","11"] },
        capacity: 3
      }
    };

    // Firestore locations
    const BOOKINGS_COL = "bookings";
    const META_COL = "meta";
    const ROOMS_DOC = "roomsState";  // meta/roomsState

    // ================== HELPERS ==================
    const $ = (id) => document.getElementById(id);
    const pad2 = (n) => String(n).padStart(2,"0");
    const escapeHtml = (str) => String(str ?? "").replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
    const formatGHS = (n)=> "GHS " + Number(n).toLocaleString("en-GH");
    const roomLabel = (v)=> v==="1"?"1 in a room":v==="2"?"2 in a room":v==="3"?"3 in a room":"—";
    const genderLabel = (g)=> g==="female"?"Female":g==="male"?"Male":"—";
    const todayISO = ()=>{
      const d = new Date(); d.setHours(0,0,0,0);
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    };
    const fmtDateTime = (d)=>{
      try{
        if (!d) return "—";
        const dt = d.toDate ? d.toDate() : new Date(d);
        return dt.toLocaleString(undefined, { year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit" });
      }catch{ return "—"; }
    };
    function showToast(where, msg, type="success"){
      const t = where==="admin" ? $("toastAdmin") : $("toastBooking");
      t.className = "toast" + (type==="error" ? " error" : "");
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=>{ t.style.display="none"; }, 7000);
    }

    function normalizeGHForWa(phoneRaw){
      let p = String(phoneRaw||"").trim().replace(/[^\d+]/g,"");
      if (!p) return "";
      if (p.startsWith("+")) p = p.slice(1);
      if (/^0\d{9}$/.test(p)) return "233"+p.slice(1);
      if (/^\d{9}$/.test(p)) return "233"+p;
      if (/^233\d{9}$/.test(p)) return p;
      return p.replace(/\D/g,"");
    }
    function waLink(phoneRaw, message){
      const wa = normalizeGHForWa(phoneRaw);
      if (!wa) return "";
      return `https://wa.me/${wa}?text=${encodeURIComponent(message||"")}`;
    }

    // ================== ROOMS STATE (CLOUD) ==================
    function defaultRooms(){
      const rooms = { "1": {}, "2": {}, "3": {} };
      for (const type of ["1","2","3"]){
        const cfg = ROOM_SETUP[type];
        for (const floor of cfg.floors){
          const list = cfg.roomsPerFloor[floor] || [];
          for (const no of list){
            const key = `${cfg.building}|F${floor}|R${no}`;
            rooms[type][key] = {
              gender: null,
              occupants: [],
              meta: { building: cfg.building, floor, roomNo: no, capacity: cfg.capacity }
            };
          }
        }
      }
      return rooms;
    }

    async function ensureRoomsDoc(){
      const ref = doc(db, META_COL, ROOMS_DOC);
      const snap = await getDoc(ref);
      if (!snap.exists()){
        await setDoc(ref, { rooms: defaultRooms(), updatedAt: serverTimestamp() });
      }
    }

    function availableSpacesAll(rooms, type){
      let spaces = 0;
      for (const key in rooms[type]){
        const r = rooms[type][key];
        spaces += Math.max(0, (r.meta.capacity||0) - (r.occupants?.length||0));
      }
      return spaces;
    }

    // ================== EMAIL CONTENT ==================
    function sendBookingReceivedEmail(b){
      return sendEmail(EMAIL.tplBooking, {
        to_name: b.fullName,
        to_email: b.email,
        hostel_name: HOSTEL_NAME,
        phone: b.phone,
        gender: genderLabel(b.gender),
        room_type: roomLabel(b.roomType),
        move_in: b.moveInDate,
        school: b.school
      });
    }

    function sendAcceptedEmail(b){
      if (!b.email) return;
      const mates = (b.roomType !== "1" && b.roommates?.length) ? b.roommates.join(", ") : "None";
      const alloc = b.allocatedRoomKey
        ? `${b.building} — Floor ${b.floor} — Room ${b.allocatedRoom}`
        : "—";
      return sendEmail(EMAIL.tplAllocated, {
        to_name: b.fullName,
        to_email: b.email,
        hostel_name: HOSTEL_NAME,
        phone: b.phone,
        gender: genderLabel(b.gender),
        room_type: roomLabel(b.roomType),
        allocation: alloc,
        roommates: mates,
        move_in: b.moveInDate,
        price: formatGHS(PRICES[String(b.roomType)] || 0),
        bank_account_name: BANK.accountName,
        bank_account_number: BANK.accountNumber,
        bank_name: BANK.bank,
        bank_branch: BANK.branch,
        school: b.school
      });
    }

    // ================== ALLOCATION (TRANSACTION) ==================
    function findRoomKey(rooms, type, gender){
      const keys = Object.keys(rooms[type]).sort((a,b)=>a.localeCompare(b));
      for (const key of keys){
        const r = rooms[type][key];
        const occ = r.occupants?.length || 0;
        const cap = r.meta?.capacity || 0;
        if (occ >= cap) continue;
        if (r.gender && r.gender !== gender) continue;
        return key;
      }
      return null;
    }

    function syncRoommatesInRoom(bookingsById, rooms, type, roomKey){
      const room = rooms[type]?.[roomKey];
      if (!room) return;
      const ids = room.occupants || [];
      for (const id of ids){
        const b = bookingsById[id];
        if (!b) continue;
        b.roommates = ids.filter(x => x !== id).map(x => bookingsById[x]?.fullName).filter(Boolean);
      }
    }

    async function allocateBookingDoc(bookingDocId){
      const roomsRef = doc(db, META_COL, ROOMS_DOC);
      const bookingRef = doc(db, BOOKINGS_COL, bookingDocId);

      const result = await runTransaction(db, async (tx) => {
        const roomsSnap = await tx.get(roomsRef);
        const bookingSnap = await tx.get(bookingRef);

        if (!roomsSnap.exists()) throw new Error("Rooms state missing.");
        if (!bookingSnap.exists()) throw new Error("Booking not found.");

        const roomsState = roomsSnap.data();
        const b = bookingSnap.data();

        if (b.status === "rejected") return { ok:false, reason:"rejected" };
        if (b.allocatedRoomKey) return { ok:true, already:true, booking: { id: bookingDocId, ...b } };

        const rooms = roomsState.rooms || defaultRooms();
        const type = b.roomType;
        const gender = b.gender;

        const roomKey = findRoomKey(rooms, type, gender);
        if (!roomKey){
          tx.update(bookingRef, { status: "waitlist", updatedAt: serverTimestamp() });
          return { ok:false, reason:"no_space" };
        }

        const room = rooms[type][roomKey];
        if (!room.gender) room.gender = gender;
        room.occupants = room.occupants || [];
        room.occupants.push(bookingDocId);

        const meta = room.meta;
        const bookingPatch = {
          status: "allocated",
          allocatedRoomKey: roomKey,
          allocatedRoom: meta.roomNo,
          floor: meta.floor,
          building: meta.building,
          updatedAt: serverTimestamp()
        };

        tx.update(roomsRef, { rooms, updatedAt: serverTimestamp() });
        tx.update(bookingRef, bookingPatch);

        return { ok:true, bookingPatch };
      });

      return result;
    }

    async function releaseBookingDoc(bookingDocId){
      const roomsRef = doc(db, META_COL, ROOMS_DOC);
      const bookingRef = doc(db, BOOKINGS_COL, bookingDocId);

      return runTransaction(db, async (tx) => {
        const roomsSnap = await tx.get(roomsRef);
        const bookingSnap = await tx.get(bookingRef);
        if (!roomsSnap.exists() || !bookingSnap.exists()) return;

        const rooms = roomsSnap.data().rooms || defaultRooms();
        const b = bookingSnap.data();
        if (!b.allocatedRoomKey) {
          tx.update(bookingRef, { status:"waitlist", updatedAt: serverTimestamp() });
          return;
        }

        const type = b.roomType;
        const rk = b.allocatedRoomKey;
        const room = rooms[type]?.[rk];
        if (room){
          room.occupants = (room.occupants || []).filter(x => x !== bookingDocId);
          if (room.occupants.length === 0) room.gender = null;
        }

        tx.update(roomsRef, { rooms, updatedAt: serverTimestamp() });
        tx.update(bookingRef, {
          status:"waitlist",
          allocatedRoomKey:"",
          allocatedRoom:"",
          floor:null,
          building:"",
          roommates: [],
          updatedAt: serverTimestamp()
        });
      });
    }

    // Pair roommates by email (2/3 only)
    async function pairRoommatesByEmail(primaryId, roommateEmail){
      roommateEmail = String(roommateEmail||"").trim().toLowerCase();
      if (!roommateEmail) return;

      const roomsRef = doc(db, META_COL, ROOMS_DOC);

      return runTransaction(db, async (tx) => {
        const roomsSnap = await tx.get(roomsRef);
        if (!roomsSnap.exists()) throw new Error("Rooms missing");
        const rooms = roomsSnap.data().rooms || defaultRooms();

        // Load all bookings (for pairing + names). For small hostel it’s ok.
        const snap = await getDocs(collection(db, BOOKINGS_COL));
        const bookings = {};
        let A = null, B = null;

        snap.forEach(d=>{
          const data = d.data();
          bookings[d.id] = { id:d.id, ...data };
          if (d.id === primaryId) A = bookings[d.id];
          if (String(data.email||"").trim().toLowerCase() === roommateEmail) B = bookings[d.id];
        });

        if (!A || !B) throw new Error("Booking(s) not found");
        if (A.id === B.id) throw new Error("Same person");
        if (A.roomType === "1" || B.roomType === "1") throw new Error("Pairing only for 2/3");
        if (A.roomType !== B.roomType) throw new Error("Different room types");
        if (A.gender !== B.gender) throw new Error("Different gender");

        const type = A.roomType;

        // choose target room: prefer A room if space
        let targetKey = A.allocatedRoomKey || "";
        const cap = ROOM_SETUP[type].capacity;

        function freeSlots(room){ return cap - (room.occupants?.length||0); }

        if (targetKey){
          const r = rooms[type]?.[targetKey];
          if (!r || (r.gender && r.gender !== A.gender) || freeSlots(r) < 1) targetKey = "";
        }

        // else find a room with >=2 free slots
        if (!targetKey){
          const keys = Object.keys(rooms[type]).sort((a,b)=>a.localeCompare(b));
          for (const k of keys){
            const r = rooms[type][k];
            if (r.gender && r.gender !== A.gender) continue;
            if (freeSlots(r) >= 2){ targetKey = k; break; }
          }
          if (!targetKey) throw new Error("No room with enough space");
        }

        // detach from current rooms
        function detach(id){
          const b = bookings[id];
          if (!b || !b.allocatedRoomKey) return;
          const rk = b.allocatedRoomKey;
          const rr = rooms[type]?.[rk];
          if (rr){
            rr.occupants = (rr.occupants||[]).filter(x => x !== id);
            if ((rr.occupants||[]).length === 0) rr.gender = null;
          }
          b.allocatedRoomKey = "";
        }
        detach(A.id);
        detach(B.id);

        // attach to target
        const room = rooms[type][targetKey];
        room.gender = A.gender;
        room.occupants = room.occupants || [];
        if (!room.occupants.includes(A.id)) room.occupants.push(A.id);
        if (!room.occupants.includes(B.id)) room.occupants.push(B.id);

        // sync roommate names
        const bookingsById = {};
        Object.values(bookings).forEach(x=> bookingsById[x.id]=x);
        syncRoommatesInRoom(bookingsById, rooms, type, targetKey);

        // write updates
        tx.update(roomsRef, { rooms, updatedAt: serverTimestamp() });

        const Aref = doc(db, BOOKINGS_COL, A.id);
        const Bref = doc(db, BOOKINGS_COL, B.id);

        const meta = room.meta;
        tx.update(Aref, {
          status:"allocated",
          allocatedRoomKey: targetKey,
          allocatedRoom: meta.roomNo,
          floor: meta.floor,
          building: meta.building,
          roommates: bookingsById[A.id].roommates || [],
          updatedAt: serverTimestamp()
        });
        tx.update(Bref, {
          status:"allocated",
          allocatedRoomKey: targetKey,
          allocatedRoom: meta.roomNo,
          floor: meta.floor,
          building: meta.building,
          roommates: bookingsById[B.id].roommates || [],
          updatedAt: serverTimestamp()
        });
      });
    }

    // ================== LIVE LISTENERS ==================
    let unsubscribeBookings = null;
    let lastRooms = null;
    let cloudBookings = [];

    async function startRoomsListener(){
      await ensureRoomsDoc();
      const ref = doc(db, META_COL, ROOMS_DOC);
      onSnapshot(ref, (snap)=>{
        if (!snap.exists()) return;
        lastRooms = snap.data().rooms || defaultRooms();
        refreshAvailabilityUI();
        readSummary();
        if (!$("adminPanel").classList.contains("hide")) renderAdmin();
      });
    }

    function startBookingsListener(){
      const q = query(collection(db, BOOKINGS_COL), orderBy("createdAt","desc"));
      unsubscribeBookings = onSnapshot(q, (snap)=>{
        cloudBookings = snap.docs.map(d => ({ id:d.id, ...d.data() }));
        if (!$("adminPanel").classList.contains("hide")) renderAdmin();
      });
    }

    // ================== UI AVAILABILITY ==================
    function refreshAvailabilityUI(){
      if (!lastRooms) return;
      $("av1").textContent = availableSpacesAll(lastRooms, "1");
      $("av2").textContent = availableSpacesAll(lastRooms, "2");
      $("av3").textContent = availableSpacesAll(lastRooms, "3");
      $("a1Admin").textContent = availableSpacesAll(lastRooms, "1");
      $("a2Admin").textContent = availableSpacesAll(lastRooms, "2");
      $("a3Admin").textContent = availableSpacesAll(lastRooms, "3");
    }

    // ================== BOOKING SUBMIT ==================
    function validateBooking(){
      const required = ["fullName","phone","email","school","roomType","moveIn","duration","gender"];
      for (const id of required){
        const el = $(id);
        const val = el.value;
        if (!val || (typeof val === "string" && val.trim()==="")){
          el.focus();
          showToast("booking","Please complete all required fields.","error");
          return false;
        }
      }
      if ($("moveIn").value < todayISO()){
        $("moveIn").focus();
        showToast("booking","Move-in date cannot be in the past.","error");
        return false;
      }
      const email = $("email").value.trim();
      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){
        $("email").focus();
        showToast("booking","Please enter a valid email.","error");
        return false;
      }
      return true;
    }

    function readSummary(){
      const type = $("roomType").value;
      const gender = $("gender").value;
      $("sumRoom").textContent = type ? roomLabel(type) : "—";
      $("sumRoomPrice").textContent = type ? formatGHS(PRICES[type]||0) : "—";
      $("sumGender").textContent = gender ? genderLabel(gender) : "—";
      if (!type || !gender || !lastRooms){
        $("sumAvail").textContent = "—";
        return;
      }
      // gender-based availability
      let spaces = 0;
      for (const key in lastRooms[type]){
        const r = lastRooms[type][key];
        if (r.gender && r.gender !== gender) continue;
        spaces += Math.max(0, (r.meta.capacity||0) - (r.occupants?.length||0));
      }
      $("sumAvail").textContent = spaces > 0 ? `Available (${spaces} space${spaces===1?"":"s"})` : "No space (Waitlist)";
    }

    async function submitBooking(){
      if (!validateBooking()) return;
      if (!lastRooms) {
        showToast("booking","Connecting to database... try again in 2 seconds.","error");
        return;
      }

      // 1) create booking doc (waitlist first)
      const booking = {
        fullName: $("fullName").value.trim(),
        phone: $("phone").value.trim(),
        email: $("email").value.trim(),
        school: $("school").value.trim(),
        gender: $("gender").value,
        roomType: $("roomType").value,
        duration: Number($("duration").value || 1),
        moveInDate: $("moveIn").value,
        notes: $("notes").value.trim(),
        status: "waitlist",
        allocatedRoomKey: "",
        allocatedRoom: "",
        floor: null,
        building: "",
        roommates: [],
        paidAt: null,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      };

      const docRef = await addDoc(collection(db, BOOKINGS_COL), booking);

      // 2) email: booking received
      sendBookingReceivedEmail({ ...booking, id: docRef.id });

      // 3) allocate (transaction)
      const allocRes = await allocateBookingDoc(docRef.id);

      // 4) show toast
      if (allocRes?.ok){
        showToast("booking",
`Booking submitted ✅
If a room was available, it has been allocated.

We sent emails to:
${booking.email}

Bank payment:
${BANK.accountName}
${BANK.accountNumber} (${BANK.bank}, ${BANK.branch})`,
"success");
      } else {
        showToast("booking",
`Booking submitted ✅
No room available for your selection.
You are on the waitlist.

Booking confirmation email sent to:
${booking.email}`,
"error");
      }

      $("bookingForm").reset();
      readSummary();
    }

    function resetBooking(){
      $("bookingForm").reset();
      readSummary();
      showToast("booking","Form reset.");
    }

    // ================== ADMIN AUTH + RENDER ==================
    function setAdminAuthed(isAuthed){
      $("adminLogin").classList.toggle("hide", isAuthed);
      $("adminPanel").classList.toggle("hide", !isAuthed);
      if (isAuthed) renderAdmin();
    }

    function loginAdmin(){
      const u = $("adminUser").value.trim();
      const p = $("adminPass").value;
      if (u===ADMIN_USER && p===ADMIN_PASS){
        sessionStorage.setItem("linmart_admin_auth","1");
        setAdminAuthed(true);
        showToast("admin","Welcome, admin!");
      } else {
        showToast("admin","Wrong username or password.","error");
      }
    }

    function logoutAdmin(){
      sessionStorage.removeItem("linmart_admin_auth");
      setAdminAuthed(false);
      showToast("admin","Logged out.");
    }

    function statusPill(status){
      const s = (status || "waitlist").toLowerCase();
      const map = {
        waitlist: { cls:"warn", label:"Waitlist" },
        allocated: { cls:"info", label:"Allocated" },
        paid: { cls:"good", label:"Paid (Confirmed)" },
        rejected: { cls:"bad", label:"Rejected" }
      };
      const x = map[s] || { cls:"warn", label:s };
      return `<span class="statusPill ${x.cls}">${x.label}</span>`;
    }

    function allocationText(b){
      if (!b.allocatedRoomKey) return "—";
      return `${b.building} — Floor ${b.floor} — Room ${b.allocatedRoom}`;
    }

    function applyAdminFilters(list){
      const q = $("search").value.trim().toLowerCase();
      const room = $("filterRoom").value;
      const gender = $("filterGender").value;
      const status = $("filterStatus").value;

      return list.filter(b=>{
        const blob = [
          b.fullName,b.phone,b.email,b.school,b.notes,
          b.roomType,b.gender,b.status,b.allocatedRoom,b.building,(b.floor||"")
        ].join(" ").toLowerCase();

        return (!q || blob.includes(q)) &&
          (!room || String(b.roomType)===room) &&
          (!gender || String(b.gender)===gender) &&
          (!status || String(b.status)===status);
      });
    }

    function updateKpis(list){
      $("kTotal").textContent = list.length;
      $("kAllocated").textContent = list.filter(b => b.status==="allocated").length;
      $("kWaitlist").textContent = list.filter(b => b.status==="waitlist").length;
      $("kPaid").textContent = list.filter(b => b.status==="paid").length;
      $("kRejected").textContent = list.filter(b => b.status==="rejected").length;
    }

    function renderAdmin(){
      updateKpis(cloudBookings);
      refreshAvailabilityUI();

      const items = applyAdminFilters(cloudBookings);
      const tbody = $("tbody");
      tbody.innerHTML = "";

      if (!items.length){
        tbody.innerHTML = `<tr><td colspan="9" style="padding:16px; color:var(--muted);">No bookings found.</td></tr>`;
        return;
      }

      for (const b of items){
        const price = formatGHS(PRICES[String(b.roomType)] || 0);
        const mates = (b.roommates && b.roommates.length) ? b.roommates.join(", ") : "—";
        const alloc = allocationText(b);

        const msg =
`Hello ${b.fullName}, ${HOSTEL_NAME} here.

Gender: ${genderLabel(b.gender)}
Room Type: ${roomLabel(String(b.roomType))} (${price})
Status: ${(b.status||"waitlist").toUpperCase()}
Allocated: ${alloc}
Roommate(s): ${mates}
Move-in: ${b.moveInDate || "—"}

Bank payment:
${BANK.accountName}
${BANK.accountNumber}
${BANK.bank} — ${BANK.branch}`.trim();

        const wlink = waLink(b.phone, msg);

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td style="color:var(--muted);">${fmtDateTime(b.createdAt)}</td>
          <td>
            <div style="font-weight:900;">${escapeHtml(b.fullName || "—")}</div>
            <div style="color:var(--muted);">${escapeHtml(b.phone || "")}</div>
            <div style="color:var(--muted);">${escapeHtml(b.email || "")}</div>
            <div style="color:var(--muted);">${escapeHtml(b.school || "")}</div>
          </td>
          <td>${genderLabel(b.gender)}</td>
          <td>${roomLabel(String(b.roomType||""))}<div style="color:var(--muted); margin-top:4px;">${price}</div></td>
          <td><span class="mono">${escapeHtml(alloc)}</span></td>
          <td>${escapeHtml(mates)}</td>
          <td>${escapeHtml(b.moveInDate || "—")}</td>
          <td>${statusPill(b.status || "waitlist")}</td>
          <td>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <button class="btn-ghost" data-act="allocate" data-id="${escapeHtml(b.id)}" type="button">Allocate</button>
              <button class="btn-warn" data-act="pair" data-id="${escapeHtml(b.id)}" type="button">Pair roommate</button>
              <button class="btn-primary" data-act="paid" data-id="${escapeHtml(b.id)}" type="button">Mark Paid</button>
              <button class="btn-ghost" data-act="release" data-id="${escapeHtml(b.id)}" type="button">Release</button>
              <button class="btn-warn" data-act="reject" data-id="${escapeHtml(b.id)}" type="button">Reject</button>
              <button class="btn-primary" data-act="email" data-id="${escapeHtml(b.id)}" type="button">Resend email</button>
              <button class="btn-primary" data-act="wa" data-id="${escapeHtml(b.id)}" type="button" ${wlink ? "" : "disabled"}>WhatsApp</button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      }
    }

    // ================== ADMIN ACTIONS ==================
    async function adminAllocate(id){
      try{
        const res = await allocateBookingDoc(id);
        if (res?.ok){
          showToast("admin","Allocated ✅ (if space existed).");
          // send accepted email (use latest booking data from cloudBookings after snapshot updates)
          const b = cloudBookings.find(x=>x.id===id);
          if (b && b.allocatedRoomKey) sendAcceptedEmail(b);
        } else {
          showToast("admin","No room available for this booking right now.","error");
        }
      } catch(e){
        console.error(e);
        showToast("admin", String(e.message||e), "error");
      }
    }

    async function adminMarkPaid(id){
      try{
        const ref = doc(db, BOOKINGS_COL, id);
        await updateDoc(ref, { status:"paid", paidAt: serverTimestamp(), updatedAt: serverTimestamp() });
        showToast("admin","Payment confirmed ✅");
      } catch(e){
        showToast("admin","Failed to mark paid.","error");
      }
    }

    async function adminRelease(id){
      try{
        await releaseBookingDoc(id);
        showToast("admin","Room released (moved to waitlist).");
      } catch(e){
        showToast("admin","Failed to release.","error");
      }
    }

    async function adminReject(id){
      try{
        // free room if allocated, then mark rejected
        await releaseBookingDoc(id);
        await updateDoc(doc(db, BOOKINGS_COL, id), { status:"rejected", updatedAt: serverTimestamp() });
        showToast("admin","Booking rejected.");
      } catch(e){
        showToast("admin","Failed to reject.","error");
      }
    }

    async function adminResendEmail(id){
      const b = cloudBookings.find(x=>x.id===id);
      if (!b) return;
      sendBookingReceivedEmail(b);
      if (b.allocatedRoomKey) sendAcceptedEmail(b);
      showToast("admin","Email resent (check EmailJS logs if not received).");
    }

    async function adminClearAll(){
      const ok = confirm("Delete ALL bookings? (Rooms will be reset too). This cannot be undone.");
      if (!ok) return;

      try{
        // delete bookings
        const snap = await getDocs(collection(db, BOOKINGS_COL));
        const deletes = [];
        snap.forEach(d => deletes.push(deleteDoc(doc(db, BOOKINGS_COL, d.id))));
        await Promise.all(deletes);

        // reset rooms
        await setDoc(doc(db, META_COL, ROOMS_DOC), { rooms: defaultRooms(), updatedAt: serverTimestamp() });

        showToast("admin","All bookings cleared and rooms reset.");
      } catch(e){
        console.error(e);
        showToast("admin","Failed to clear all.","error");
      }
    }

    // ================== VIEW SWITCH ==================
    function setView(which){
      const isBooking = which === "booking";
      $("viewBooking").classList.toggle("hide", !isBooking);
      $("viewAdmin").classList.toggle("hide", isBooking);

      $("tabBooking").classList.toggle("active", isBooking);
      $("tabAdmin").classList.toggle("active", !isBooking);

      $("tabBooking").setAttribute("aria-selected", isBooking ? "true" : "false");
      $("tabAdmin").setAttribute("aria-selected", !isBooking ? "true" : "false");

      if (!isBooking){
        const authed = sessionStorage.getItem("linmart_admin_auth") === "1";
        setAdminAuthed(authed);
      }
    }

    // ================== EVENTS ==================
    $("tabBooking").addEventListener("click", ()=>setView("booking"));
    $("tabAdmin").addEventListener("click", ()=>setView("admin"));
    ["roomType","duration","gender"].forEach(id => $(id).addEventListener("change", readSummary));
    $("submitBtn").addEventListener("click", submitBooking);
    $("resetBtn").addEventListener("click", resetBooking);

    $("loginBtn").addEventListener("click", loginAdmin);
    $("logoutBtn").addEventListener("click", logoutAdmin);
    $("clearBtn").addEventListener("click", adminClearAll);

    ["search","filterRoom","filterGender","filterStatus"].forEach(id => {
      $(id).addEventListener("input", renderAdmin);
      $(id).addEventListener("change", renderAdmin);
    });

    document.addEventListener("click", async (e)=>{
      const btn = e.target.closest("button[data-act]");
      if (!btn) return;
      const act = btn.dataset.act;
      const id = btn.dataset.id;

      if (act === "allocate") return adminAllocate(id);
      if (act === "paid") return adminMarkPaid(id);
      if (act === "release") return adminRelease(id);
      if (act === "reject") return adminReject(id);
      if (act === "email") return adminResendEmail(id);

      if (act === "pair"){
        const roommateEmail = prompt("Enter roommate email (must already have a booking):");
        if (!roommateEmail) return;
        try{
          await pairRoommatesByEmail(id, roommateEmail);
          showToast("admin","Paired ✅");
          // resend accepted emails for both (after snapshots update)
          setTimeout(()=>{
            const A = cloudBookings.find(x=>x.id===id);
            if (A && A.allocatedRoomKey) sendAcceptedEmail(A);
          }, 1200);
        } catch(err){
          showToast("admin", String(err.message||err), "error");
        }
        return;
      }

      if (act === "wa"){
        const b = cloudBookings.find(x=>x.id===id);
        if (!b) return;

        const price = formatGHS(PRICES[String(b.roomType)] || 0);
        const mates = (b.roommates && b.roommates.length) ? b.roommates.join(", ") : "—";

        const msg =
`Hello ${b.fullName}, ${HOSTEL_NAME} here.

Gender: ${genderLabel(b.gender)}
Room Type: ${roomLabel(String(b.roomType))} (${price})
Status: ${(b.status||"waitlist").toUpperCase()}
Allocated: ${allocationText(b)}
Roommate(s): ${mates}
Move-in: ${b.moveInDate || "—"}

Bank payment:
${BANK.accountName}
${BANK.accountNumber}
${BANK.bank} — ${BANK.branch}`.trim();

        const link = waLink(b.phone, msg);
        if (!link) return showToast("admin","Phone number invalid for WhatsApp.","error");
        window.open(link, "_blank", "noopener,noreferrer");
      }
    });

    // ================== INIT ==================
    (function init(){
      $("year").textContent = new Date().getFullYear();
      $("moveIn").min = todayISO();
      readSummary();

      const authed = sessionStorage.getItem("linmart_admin_auth") === "1";
      setAdminAuthed(authed);

      startRoomsListener();
      startBookingsListener();
    })();
  </script>
</body>
</html>
